@model RepositorioDocumentos.ViewModels.DocumentPreviewViewModel.DocumentContainer
@{
    Layout = null;

    var topicNumber = 0;
}

<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@Model.DocumentHeader.Title (Vista Preliminar)</title>
    <style>

        body {
            max-width: 7in;
            min-width: 7in;
            margin: 0 auto;
        }

        #table-container thead {
            display: table-header-group; /* Ensures the header is repeated on each page */
        }

        #table-container tfoot {
            display: table-footer-group; /* Ensures the footer is repeated on each page */
        }

        .container {
            height: 100px; /* Especifica la altura del contenedor aquí */
            width: 100%;
            display: flex;
            align-items: stretch;
            border: 1px solid #000;
        }

        #table-container {
            height: 100%;
            width: 100%;
            border-collapse: collapse;
            margin: 0;
        }

        .full-height-table {
            width: 100%;
            height: 100%;
            border-collapse: collapse;
        }

            .full-height-table td {
                border: 1px solid #000;
                padding: 8px;
                text-align: left;
                vertical-align: top;
            }

            .full-height-table tr {
                height: 100%;
            }

        #docHeaderTable tr td {
            text-align: left;
            padding-left: 5px;
        }

        .text-bold {
            font-weight: bold;
            background-color: #f5e9d1;
        }

        .border-table tr td {
            border: 1px solid black;
        }

        .topic-doc {
            margin-top: 20px;
            color: blue;
            font-weight: bold;
        }

        .watermark {
            display: none;
        }

        .detailTables thead tr th {
            border: 1px solid gray;
            padding: 3px;
            background-color: #f5e9d1;
        }

        .detailTables tbody tr td {
            border: 1px solid gray;
            padding: 3px;
        }

        .btn-margin-general {
            color: white;
            text-decoration: none;
            position: absolute;
            bottom: 0;
        }
    </style>
    <link rel="stylesheet" href="~/Content/doc-preview.css">
    @*<script src="https://cdnjs.com/libraries/pdf.js"></script>*@
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            let totalPages = document.querySelectorAll('.pageNumber').length;
            document.querySelectorAll('.totalPages').forEach(function (span) {
                span.textContent = totalPages;
            });
        });
    </script>
</head>

<body id="container-id">
    <div class="watermark">CONFIDENCIAL</div>
  
    <table id="table-container">
        <thead class="cabecera">
            <tr><th style="height: 40px"></th></tr>
            <tr>
                <th>
                    <table id="header-section" class="table-container-class" cellspacing="0" cellpadding="0" style="border: 2px solid black; width: 100%">
                        <tr>
                            <td style="width: 120px; text-align: center; border: 1px solid black;"><img src="~/Content/images/RCImageDoc.png" width="90" alt="Logo RC" /></td>
                            <td>
                                <div class="container">
                                    <table width="100%">
                                        <tr>
                                            <td style="text-align: center; vertical-align: top; height: 20px; border-bottom: 2px solid black">Documentación</td>
                                        </tr>

                                        <tr>
                                            <td style="text-align: center;">@Model.DocumentHeader.DocumentType.Description</td>
                                        </tr>
                                    </table>
                                </div>
                            </td>
                            <td style="width: 250px; padding-left: 5px; border: 1px solid black; text-align: left;">

                                <table width="100%" height="100%" cellspacing="5" cellpadding="0">
                                    <tr>
                                        <td>Código: @Model.DocumentHeader.Code</td>
                                    </tr>
                                    <tr>
                                        <td>Revisión: @Model.DocumentHeader.Revision</td>
                                    </tr>
                                    <tr>
                                        <td>Fecha: @Model.DocumentHeader.Date.ToString("dd/MM/yyyy")</td>
                                    </tr>
                                    <tr>
                                        <td><div class="page-number-header" id="content-page">Página 0 de 0</div></td>
                                    </tr>
                                </table>

                            </td>
                        </tr>

                    </table>
                </th>
            </tr>
            <tr><th style="height: 34px;"></th></tr>
        </thead>
        <tfoot>
            <tr>
                <td style="text-align: right; color: gray; height: 40px; vertical-align: central; padding-right: 10px;">
                    @Model.DocumentHeader.Title
                    @*<br />Page <span class="pageNumber"></span> of <span class="totalPages"></span>*@
                </td>
            </tr>
            <tr>
                <td style="height: 5px; padding-top: 10px;">
                    <span style="color: white">.</span>
                </td>

            </tr>
        </tfoot>
        <tbody>
            <tr>
                <td>
                    <div style="text-align: center;">
                        <table id="docHeaderTable" width="100%" cellspacing="0" cellpadding="0" border="1" style="margin: 0 auto;">
                            <tr>
                                <td style="width: 150px;">Título</td>
                                <td class="text-bold">@Model.DocumentHeader.Title</td>
                            </tr>
                            <tr>
                                <td>Dirección</td>
                                <td class="text-bold">@Model.DocumentHeader.Directorate.Description</td>
                            </tr>
                            <tr>
                                <td>Departamento</td>
                                <td class="text-bold">@Model.DocumentHeader.Department.DeptoName</td>
                            </tr>
                            <tr>
                                <td>Area</td>
                                <td class="text-bold">@Model.DocumentHeader.Area.Description</td>
                            </tr>
                            <tr>
                                <td>Macroproceso</td>
                                <td class="text-bold">@Model.DocumentHeader.Macroprocess.Description</td>
                            </tr>
                            <tr>
                                <td>Proceso</td>
                                <td class="text-bold">@Model.DocumentHeader.Process.Description</td>
                            </tr>
                        </table>
                    </div>

                    <div style="text-align: justify">
                        @if (Model.DocumentHeader.AttachmentType != true && !string.IsNullOrEmpty(Model.DocumentHeader.Objective))
                        {
                            topicNumber += 1;
                            <div id="margin-objective"></div>
                            <div class="section-margin" style="position: relative; height: 24px">

                                <a href="javascript:void(0);" class="btn-margin-general btn-margin-manually-objective">Agregar margen de espacio</a>
                            </div>

                            <p class="topic-doc">
                                @topicNumber. OBJETIVO
                            </p>
                            <span style="text-align: justify">
                                @Html.Raw(Model.DocumentHeader.Objective)
                            </span>
                        }

                        @if (Model.DocumentContent != null && !string.IsNullOrEmpty(Model.DocumentContent.Body))
                        {
                            topicNumber += 1;
                            var content = "CONTENIDO";

                            if (Model.DocumentHeader.DocumentType.Description.ToLower().Contains("instructivo"))
                            {
                                content = "PASOS";
                            }

                            <div id="margin-body"></div>
                            <div class="section-margin" style="position: relative; height: 24px">

                                <a href="javascript:void(0);" class="btn-margin-general btn-margin-manually-body">Agregar margen de espacio</a>
                            </div>
                            <p class="topic-doc">@topicNumber. @content</p>
                            <span style="text-align: justify">
                                @Html.Raw(Model.DocumentContent.Body)
                            </span>
                        }

                        @if (Model.DocumentDetail != null)
                        {
                            if (!string.IsNullOrEmpty(Model.DocumentDetail.Scope))
                            {
                                topicNumber += 1;

                                <div id="margin-scope"></div>
                                <div class="section-margin" style="position: relative; height: 24px">

                                    <a href="javascript:void(0);" class="btn-margin-general btn-margin-manually-scope">Agregar margen de espacio</a>
                                </div>

                                <p class="topic-doc">@topicNumber. ALCANCE</p>
                                <span style="text-align: justify">
                                    @Html.Raw(Model.DocumentDetail.Scope)
                                </span>
                            }

                            if (!string.IsNullOrEmpty(Model.DocumentDetail.Responsabilities))
                            {
                                topicNumber += 1;

                                <div id="margin-responsabilities"></div>
                                <div class="section-margin" style="position: relative; height: 24px">

                                    <a href="javascript:void(0);" class="btn-margin-general btn-margin-manually-responsabilities">Agregar margen de espacio</a>
                                </div>

                                <p class="topic-doc">@topicNumber. RESPONSABILIDADES</p>
                                <span>
                                    @Html.Raw(Model.DocumentDetail.Responsabilities)
                                </span>
                            }
                        }

                        @if (Model.DocumentGuidelines.Count() > 0)
                        {
                            topicNumber += 1;

                            <div id="margin-guidelines"></div>
                            <div class="section-margin" style="position: relative; height: 24px">

                                <a href="javascript:void(0);" class="btn-margin-general btn-margin-manually-guidelines">Agregar margen de espacio</a>
                            </div>

                            <p class="topic-doc">@topicNumber. DIRECTRICES</p>
                            <table id="guidelineTable" class="border-table" cellpadding="4" style="width:100%; border-collapse: collapse">
                                @foreach (var item in Model.DocumentGuidelines)
                                {
                                    <tr>
                                        <td style="text-align: center; width: 60px">@item.SortIndex</td>
                                        <td style="text-align: justify">@item.Description</td>
                                    </tr>
                                }
                            </table>
                        }

                        @if (Model.DocumentDetail != null && !string.IsNullOrEmpty(Model.DocumentDetail.Policy))
                        {
                            topicNumber += 1;

                            <div id="margin-policy"></div>
                            <div class="section-margin" style="position: relative; height: 24px">

                                <a href="javascript:void(0);" class="btn-margin-general btn-margin-manually-policy">Agregar margen de espacio</a>
                            </div>

                            <p class="topic-doc">@topicNumber. POLITICA</p>
                            <div>
                                @*@Html.Raw(Model.DocumentDetail.Policy.Replace("<ol>", "<ul>").Replace("</ol>", "</ul>"))*@
                                @Html.Raw(Model.DocumentDetail.Policy)
                            </div>
                        }

                        @if (Model.DocumentProcedures.Count() > 0)
                        {
                            topicNumber += 1;

                            <div id="margin-procedures"></div>
                            <div class="section-margin" style="position: relative; height: 24px">

                                <a href="javascript:void(0);" class="btn-margin-general btn-margin-manually-procedures">Agregar margen de espacio</a>
                            </div>

                            <p class="topic-doc">@topicNumber. PROCEDIMIENTO</p>
                            <table id="procedureTable" class="border-table" cellpadding="4" style="width:100%; border-collapse: collapse">
                                <tr>
                                    <td style="text-align: center; width: 60px"> <strong>Numeral</strong></td>
                                    <td style="text-align: center; width: 130px"> <strong>Responsable</strong></td>
                                    <td style="text-align: center;"> <strong>Descripción</strong></td>
                                </tr>
                                @foreach (var item in Model.DocumentProcedures)
                                {
                                    <tr>
                                        <td style="text-align: center;">@item.SortIndex</td>
                                        <td style="text-align: center;">@item.Responsible</td>
                                        <td style="text-align: justify">@Html.Raw(item.Description)</td>
                                    </tr>
                                }
                            </table>
                        }

                        @if (Model.DocumentReferences.Count() > 0)
                        {
                            topicNumber += 1;

                            <div id="margin-references"></div>
                            <div class="section-margin" style="position: relative; height: 24px">

                                <a href="javascript:void(0);" class="btn-margin-general btn-margin-manually-references">Agregar margen de espacio</a>
                            </div>
                            <p class="topic-doc">@topicNumber. REFERENCIAS O ANEXOS</p>

                            <ul>
                                @foreach (var item in Model.DocumentReferences)
                                {
                                    <li>@item.Name</li>
                                }
                            </ul>
                        }

                        @if (Model.DocumentChanges.Count() > 0)
                        {
                            topicNumber += 1;

                            <div id="margin-changes"></div>
                            <div class="section-margin" style="position: relative; height: 24px">

                                <a href="javascript:void(0);" class="btn-margin-general btn-margin-manually-changes">Agregar margen de espacio</a>
                            </div>
                            <p class="topic-doc">@topicNumber. NOTIFICACION DE CAMBIOS</p>

                            <table width="100%" cellpadding="0" cellspacing="0" id="changesTable" class="detailTables">
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th style="text-align: center">Revisión</th>
                                        <th style="text-align: center">Páginas Afectadas</th>
                                        <th style="text-align: center">Originador del Cambio</th>
                                        <th style="text-align: center">Naturaleza del Cambio</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in Model.DocumentChanges)
                                    {
                                        <tr>
                                            <td>@item.Date.ToString("dd/MM/yyyy")</td>
                                            <td style="text-align: center">@item.Revision</td>
                                            <td style="text-align: center">@item.PagesAffected</td>
                                            <td style="text-align: left">@item.Originator</td>
                                            <td style="text-align: left">@item.NatureChange</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        }

                        @if (Model.DocumentApprovals.Count() > 0)
                        {
                            topicNumber += 1;

                            <div id="margin-approvals"></div>
                            <div class="section-margin" style="position: relative; height: 24px">

                                <a href="javascript:void(0);" class="btn-margin-general btn-margin-manually-approvals">Agregar margen de espacio</a>
                            </div>
                            <p class="topic-doc">@topicNumber. APROBACION</p>

                            <table width="100%" cellpadding="0" cellspacing="0" id="approvalsTable" class="detailTables">
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Elaborado por</th>
                                        <th>Gerente del Area</th>
                                        <th>Director de Area</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in Model.DocumentApprovals)
                                    {
                                        <tr>
                                            <td>@item.CreatedDate.ToString("dd/MM/yyyy")</td>
                                            <td style="text-align: left">@item.ProducedByName</td>
                                            <td style="text-align: left">@item.ManagerAreaName</td>
                                            <td style="text-align: left">@item.DirectorAreaName</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        }


                        @if (!string.IsNullOrEmpty(Model.DocumentHeader.FootNote))
                        {
                            
                            <div class="section-margin" style="position: relative; margin-top: 50px; margin-bottom: 40px; height: 24px">
                                <span>"@(Model.DocumentHeader.FootNote)"</span>
                            </div>
                        }
                    </div>
                </td>
            </tr>
        </tbody>

    </table>
    <footer></footer>
</body>
</html>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script type="text/javascript">
    $(document).ready(function () {

        $(".btn-margin-manually-objective").on("click", function (evt) {
            $("#margin-objective").append("<br/>");
        })

        $(".btn-margin-manually-body").on("click", function (evt) {
            $("#margin-body").append("<br/>");
        })

        $(".btn-margin-manually-scope").on("click", function (evt) {
            $("#margin-scope").append("<br/>");
        })

        $(".btn-margin-manually-responsabilities").on("click", function (evt) {
            $("#margin-responsabilities").append("<br/>");
        })

        $(".btn-margin-manually-guidelines").on("click", function (evt) {
            $("#margin-guidelines").append("<br/>");
        })

        $(".btn-margin-manually-policy").on("click", function (evt) {
            $("#margin-policy").append("<br/>");
        })

        $(".btn-margin-manually-procedures").on("click", function (evt) {
            $("#margin-procedures").append("<br/>");
        })

        $(".btn-margin-manually-references").on("click", function (evt) {
            $("#margin-references").append("<br/>");
        })

        $(".btn-margin-manually-changes").on("click", function (evt) {
            $("#margin-changes").append("<br/>");
        })

        $(".btn-margin-manually-approvals").on("click", function (evt) {
            $("#margin-approvals").append("<br/>");
        })

        var contentHeight = document.getElementById("container-id").offsetHeight;

        // Assuming an A4 page height in pixels (11.69 inches * 96 DPI = 1122 pixels at 96 DPI)
        var pageHeight = 900; // Typical page height for A4 in pixels at 96 DPI

        // Calculate the number of pages
        var totalPages = Math.ceil(contentHeight / pageHeight);

        // Display the result
        console.log("Total number of pages: " + totalPages);
        $("#content-page").html(`Página 1 de ${totalPages}`)

        window.onbeforeprint = function () {

            console.log('page-number-header:', $(".table-container-class").length);
        }

        //function addPageNumbers() {
        //    console.log('DOING....')
        //    var totalPages = Math.ceil($('#container-id')[0].scrollHeight / (11 * 96)); // 11 inches in pixels at 96dpi

        //    console.log('PAGINAS 1: ', $('.page-number-header').length);
        //    console.log('PAGINAS 2: ', $('#table-container thead').length);
        //    console.log('PAGINAS 3: ', $('.cabecera').length);


        //    $('.page-number-header').each(function (index) {
        //        console.log('Pagina: ', index + 1, ' de ', totalPages);
        //        $(this).html('<div class="page-number">Página ' + (index + 1) + ' de ' + totalPages + '</div>');
        //    });
        //}

        //window.onbeforeprint = addPageNumbers;
    });
</script>